-- 1. Unify the 12 data tables
CREATE OR REPLACE TABLE
  `all_trips_master_table` AS


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data-06_2024`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data_07_2024`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data_08_2024`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data-09_2024`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data_10_2024`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data_11_2024`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data-12_2024`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data_01_2025`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data_02_2025`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data-03_2025`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data_04_2025`

UNION ALL


SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  member_casual
FROM
  `trip_data_05_2025`

--2. Find duplicate ride_ids
SELECT
  ride_id,
  COUNT(*) AS id_count
FROM
  `all_trips_master_table`
GROUP BY
  ride_id
HAVING
  COUNT(*) > 1;

--3. Remove rows with NULLs in critical columns
CREATE OR REPLACE TABLE
  `all_trips_no_nulls` AS
SELECT
  *
FROM
  `all_trips_no_duplicates`
WHERE
  ride_id IS NOT NULL
  AND started_at IS NOT NULL
  AND ended_at IS NOT NULL
  AND member_casual IS NOT NULL;

-- 4. Remove invalid durations & add duration
CREATE OR REPLACE TABLE
  `all_trips_valid_duration` AS
SELECT
  *,
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) AS ride_length_seconds
FROM
  `all_trips_no_nulls`
WHERE
  TIMESTAMP_DIFF(ended_at, started_at, SECOND) > 0;

-- 5. Standardize text fields
CREATE OR REPLACE TABLE
  `all_trips_standardized` AS
SELECT
  *,
  LOWER(member_casual) AS member_casual_clean,
  LOWER(rideable_type) AS rideable_type_clean
FROM
  `all_trips_no_outliers`;

-- 6. Final cleaned table with extra time fields
CREATE OR REPLACE TABLE
  `your-project-id.your-dataset.all_trips_final` AS
SELECT
  *,
  FORMAT_DATE('%A', DATE(started_at)) AS day_of_week,
  FORMAT_DATE('%Y-%m', DATE(started_at)) AS ride_month
FROM
  `your-project-id.your-dataset.all_trips_stations_clean`;